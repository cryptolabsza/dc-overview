<!DOCTYPE html>
<html><head>
    <title>Server Manager - Settings</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    {% include "_base_style.html" %}

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Server Manager</h1>
            <div class="nav">
                <a href="/" class="nav-home">Home</a>
                <span class="nav-sep">|</span>
                <a href="/dashboard" data-nav>Dashboard</a>
                <a href="/servers" data-nav>Servers</a>
                <a href="/settings" class="active" data-nav>Settings</a>
                <a href="/logout" data-nav>Logout</a>
            </div>
        </div>
        
        <div class="card">
            <h2>Integration URLs</h2>
            <div class="form-group">
                <label>Grafana URL</label>
                <input type="text" value="{{ grafana_url }}" readonly>
            </div>
            <div class="form-group">
                <label>Prometheus URL</label>
                <input type="text" value="{{ prometheus_url }}" readonly>
            </div>
        </div>
        
        <div class="card">
            <h2>SSH Keys</h2>
            {% if ssh_keys %}
            <table>
                <thead>
                    <tr><th>Name</th><th>Path</th><th>Fingerprint</th><th>Actions</th></tr>
                </thead>
                <tbody id="sshKeysTable">
                    {% for key in ssh_keys %}
                    <tr data-id="{{ key.id }}">
                        <td>{{ key.name }}</td>
                        <td style="font-family: monospace; font-size: 0.85rem;">{{ key.key_path }}</td>
                        <td style="font-family: monospace; font-size: 0.85rem;">{{ key.fingerprint or '—' }}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteSSHKey({{ key.id }})">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color: var(--text-secondary);">No SSH keys configured.</p>
            {% endif %}
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                <h3>Add SSH Key</h3>
                <form id="addSSHKeyForm">
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px;">
                        <div class="form-group">
                            <label>Key Name</label>
                            <input type="text" name="name" placeholder="my-ssh-key" required>
                        </div>
                        <div class="form-group">
                            <label>Key Path (inside container)</label>
                            <input type="text" name="key_path" placeholder="/etc/dc-overview/ssh_keys/id_rsa" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add SSH Key</button>
                </form>
            </div>
        </div>
        
        <div class="card">
            <h2>Vast.ai Accounts</h2>
            <p style="color: var(--text-secondary); margin-bottom: 15px;">
                Manage Vast.ai API keys for the metrics exporter. Accounts are validated on add and persisted across restarts.
            </p>
            <div id="vastAccountsLoading" style="color: var(--text-secondary);">Loading accounts...</div>
            <table id="vastAccountsTable" style="display:none;">
                <thead>
                    <tr><th>Account</th><th>API Key</th><th>Status</th><th>Balance</th><th>Machines</th><th>Actions</th></tr>
                </thead>
                <tbody id="vastAccountsBody"></tbody>
            </table>
            <div id="vastAccountsEmpty" style="display:none; color: var(--text-secondary);">
                No Vast.ai accounts configured. Add one below.
            </div>
            <div id="vastAccountsError" style="display:none; color: #e74c3c;"></div>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                <h3>Add Vast.ai Account</h3>
                <form id="addVastAccountForm">
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px;">
                        <div class="form-group">
                            <label>Account Name</label>
                            <input type="text" name="name" placeholder="MyVastAccount" required>
                        </div>
                        <div class="form-group">
                            <label>API Key</label>
                            <input type="text" name="key" placeholder="Vast.ai API key from Account > API Keys" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" id="addVastBtn">Add Account</button>
                    <span id="addVastStatus" style="margin-left: 10px; font-size: 0.9rem;"></span>
                </form>
            </div>
        </div>
        
        <div class="card">
            <h2>RunPod Accounts</h2>
            <p style="color: var(--text-secondary); margin-bottom: 15px;">
                Manage RunPod API keys for the metrics exporter. Accounts are validated on add and persisted across restarts.
            </p>
            <div id="runpodAccountsLoading" style="color: var(--text-secondary);">Loading accounts...</div>
            <table id="runpodAccountsTable" style="display:none;">
                <thead>
                    <tr><th>Account</th><th>API Key</th><th>Status</th><th>Balance</th><th>Machines</th><th>Actions</th></tr>
                </thead>
                <tbody id="runpodAccountsBody"></tbody>
            </table>
            <div id="runpodAccountsEmpty" style="display:none; color: var(--text-secondary);">
                No RunPod accounts configured. Add one below.
            </div>
            <div id="runpodAccountsError" style="display:none; color: #e74c3c;"></div>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                <h3>Add RunPod Account</h3>
                <form id="addRunpodAccountForm">
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px;">
                        <div class="form-group">
                            <label>Account Name</label>
                            <input type="text" name="name" placeholder="MyRunPodAccount" required>
                        </div>
                        <div class="form-group">
                            <label>API Key</label>
                            <input type="text" name="key" placeholder="rpa_XXXXX (from RunPod Settings > API Keys)" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" id="addRunpodBtn">Add Account</button>
                    <span id="addRunpodStatus" style="margin-left: 10px; font-size: 0.9rem;"></span>
                </form>
            </div>
        </div>
        
        <div class="card">
            <h2>API Endpoints</h2>
            <table>
                <tr><td><code>/api/health</code></td><td>Health check</td></tr>
                <tr><td><code>/api/servers</code></td><td>List/manage servers</td></tr>
                <tr><td><code>/api/ssh-keys</code></td><td>List/manage SSH keys</td></tr>
                <tr><td><code>/api/vast/accounts</code></td><td>List/manage Vast.ai accounts</td></tr>
                <tr><td><code>/api/runpod/accounts</code></td><td>List/manage RunPod accounts</td></tr>
                <tr><td><code>/api/prometheus/targets.json</code></td><td>Prometheus file_sd targets</td></tr>
                <tr><td><code>/metrics</code></td><td>Prometheus metrics</td></tr>
            </table>
        </div>
        
        <p class="version">Server Manager v{{ version }}</p>
    </div>
    
    <script>
    // Get base path for API calls - extract /dc from any subpath like /dc/settings
    const basePath = window.location.pathname.match(/^(\/[^\/]+)/)?.[1] || '';
    
    // Fix nav links to include base path (e.g. /dc/servers instead of /servers)
    document.querySelectorAll('.nav a[data-nav]').forEach(a => {
        a.href = basePath + a.getAttribute('href');
    });
    
    // ---- SSH Keys ----
    document.getElementById('addSSHKeyForm').onsubmit = async (e) => {
        e.preventDefault();
        const form = e.target;
        const data = {
            name: form.name.value,
            key_path: form.key_path.value
        };
        
        const response = await fetch(`${basePath}/api/ssh-keys`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const result = await response.json();
            alert(result.error || 'Failed to add SSH key');
        }
    };
    
    async function deleteSSHKey(id) {
        if (!confirm('Delete this SSH key?')) return;
        
        const response = await fetch(`${basePath}/api/ssh-keys/${id}`, {method: 'DELETE'});
        
        if (response.ok) {
            location.reload();
        } else {
            const result = await response.json();
            alert(result.error || 'Failed to delete SSH key');
        }
    }
    
    // ---- Vast.ai Accounts ----
    async function loadVastAccounts() {
        const loading = document.getElementById('vastAccountsLoading');
        const table = document.getElementById('vastAccountsTable');
        const tbody = document.getElementById('vastAccountsBody');
        const empty = document.getElementById('vastAccountsEmpty');
        const errorDiv = document.getElementById('vastAccountsError');
        
        try {
            const response = await fetch(`${basePath}/api/vast/accounts`);
            loading.style.display = 'none';
            
            if (!response.ok) {
                const result = await response.json().catch(() => ({}));
                errorDiv.textContent = result.error || 'Failed to load accounts (exporter may not be running)';
                errorDiv.style.display = 'block';
                return;
            }
            
            const data = await response.json();
            const accounts = data.accounts || [];
            
            if (accounts.length === 0) {
                empty.style.display = 'block';
                return;
            }
            
            tbody.innerHTML = '';
            for (const acct of accounts) {
                const statusColor = acct.status === 'connected' ? '#2ecc71' : '#e74c3c';
                const statusIcon = acct.status === 'connected' ? '✓' : '✗';
                const balance = acct.balance !== null ? `$${acct.balance.toFixed(2)}` : '—';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${acct.name}</strong></td>
                    <td style="font-family: monospace; font-size: 0.85rem;">${acct.key_masked}</td>
                    <td style="color: ${statusColor};">${statusIcon} ${acct.status}</td>
                    <td>${balance}</td>
                    <td>${acct.machine_count}</td>
                    <td>
                        <button class="btn btn-sm" onclick="testVastAccount('${acct.name}')" style="margin-right:5px;">Test</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteVastAccount('${acct.name}')">Remove</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
            table.style.display = '';
            
        } catch (e) {
            loading.style.display = 'none';
            errorDiv.textContent = 'Could not connect to Vast.ai exporter: ' + e.message;
            errorDiv.style.display = 'block';
        }
    }
    
    document.getElementById('addVastAccountForm').onsubmit = async (e) => {
        e.preventDefault();
        const form = e.target;
        const btn = document.getElementById('addVastBtn');
        const status = document.getElementById('addVastStatus');
        
        btn.disabled = true;
        status.textContent = 'Validating API key...';
        status.style.color = 'var(--text-secondary)';
        
        try {
            const response = await fetch(`${basePath}/api/vast/accounts`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: form.name.value,
                    key: form.key.value
                })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                status.textContent = `✓ Added (balance: $${result.balance?.toFixed(2) || 'N/A'})`;
                status.style.color = '#2ecc71';
                form.reset();
                setTimeout(() => loadVastAccounts(), 500);
            } else {
                status.textContent = '✗ ' + (result.error || 'Failed to add account');
                status.style.color = '#e74c3c';
            }
        } catch (e) {
            status.textContent = '✗ Connection error: ' + e.message;
            status.style.color = '#e74c3c';
        }
        
        btn.disabled = false;
    };
    
    async function deleteVastAccount(name) {
        if (!confirm(`Remove Vast.ai account "${name}"? Metrics for this account will stop.`)) return;
        
        const response = await fetch(`${basePath}/api/vast/accounts/${encodeURIComponent(name)}`, {method: 'DELETE'});
        
        if (response.ok) {
            loadVastAccounts();
        } else {
            const result = await response.json().catch(() => ({}));
            alert(result.error || 'Failed to remove account');
        }
    }
    
    async function testVastAccount(name) {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Testing...';
        
        try {
            const response = await fetch(`${basePath}/api/vast/accounts/${encodeURIComponent(name)}/test`);
            const result = await response.json();
            
            if (result.status === 'connected') {
                let msg = `Account: ${name}\\nStatus: Connected\\nBalance: $${result.balance?.toFixed(2)}\\nMachines: ${result.machine_count}`;
                if (result.machines && result.machines.length > 0) {
                    msg += '\\n\\nMachines:';
                    for (const m of result.machines) {
                        msg += `\\n  ${m.hostname}: ${m.num_gpus} GPUs, occupancy=${m.gpu_occupancy}, listed=${m.listed}`;
                    }
                }
                alert(msg);
            } else {
                alert(`Account "${name}" test failed: ${result.error || 'Unknown error'}`);
            }
        } catch (e) {
            alert('Connection error: ' + e.message);
        }
        
        btn.disabled = false;
        btn.textContent = 'Test';
    }
    
    // ---- RunPod Accounts ----
    async function loadRunpodAccounts() {
        const loading = document.getElementById('runpodAccountsLoading');
        const table = document.getElementById('runpodAccountsTable');
        const tbody = document.getElementById('runpodAccountsBody');
        const empty = document.getElementById('runpodAccountsEmpty');
        const errorDiv = document.getElementById('runpodAccountsError');
        
        try {
            const response = await fetch(`${basePath}/api/runpod/accounts`);
            loading.style.display = 'none';
            
            if (!response.ok) {
                const result = await response.json().catch(() => ({}));
                errorDiv.textContent = result.error || 'Failed to load accounts (exporter may not be running)';
                errorDiv.style.display = 'block';
                return;
            }
            
            const data = await response.json();
            const accounts = data.accounts || [];
            
            if (accounts.length === 0) {
                empty.style.display = 'block';
                return;
            }
            
            tbody.innerHTML = '';
            for (const acct of accounts) {
                const statusColor = acct.status === 'connected' ? '#2ecc71' : '#e74c3c';
                const statusIcon = acct.status === 'connected' ? '✓' : '✗';
                const balance = acct.balance !== null ? `$${Number(acct.balance).toFixed(2)}` : '—';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${acct.name}</strong></td>
                    <td style="font-family: monospace; font-size: 0.85rem;">${acct.key_masked}</td>
                    <td style="color: ${statusColor};">${statusIcon} ${acct.status}</td>
                    <td>${balance}</td>
                    <td>${acct.machine_count}</td>
                    <td>
                        <button class="btn btn-sm" onclick="testRunpodAccount('${acct.name}')" style="margin-right:5px;">Test</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteRunpodAccount('${acct.name}')">Remove</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
            table.style.display = '';
            
        } catch (e) {
            loading.style.display = 'none';
            errorDiv.textContent = 'Could not connect to RunPod exporter: ' + e.message;
            errorDiv.style.display = 'block';
        }
    }
    
    document.getElementById('addRunpodAccountForm').onsubmit = async (e) => {
        e.preventDefault();
        const form = e.target;
        const btn = document.getElementById('addRunpodBtn');
        const status = document.getElementById('addRunpodStatus');
        
        btn.disabled = true;
        status.textContent = 'Validating API key...';
        status.style.color = 'var(--text-secondary)';
        
        try {
            const response = await fetch(`${basePath}/api/runpod/accounts`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: form.name.value,
                    key: form.key.value
                })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                status.textContent = `✓ Added (balance: $${Number(result.balance || 0).toFixed(2)}, ${result.machine_count || 0} machine(s))`;
                status.style.color = '#2ecc71';
                form.reset();
                setTimeout(() => loadRunpodAccounts(), 500);
            } else {
                status.textContent = '✗ ' + (result.error || 'Failed to add account');
                status.style.color = '#e74c3c';
            }
        } catch (e) {
            status.textContent = '✗ Connection error: ' + e.message;
            status.style.color = '#e74c3c';
        }
        
        btn.disabled = false;
    };
    
    async function deleteRunpodAccount(name) {
        if (!confirm(`Remove RunPod account "${name}"? Metrics for this account will stop.`)) return;
        
        const response = await fetch(`${basePath}/api/runpod/accounts/${encodeURIComponent(name)}`, {method: 'DELETE'});
        
        if (response.ok) {
            loadRunpodAccounts();
        } else {
            const result = await response.json().catch(() => ({}));
            alert(result.error || 'Failed to remove account');
        }
    }
    
    async function testRunpodAccount(name) {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Testing...';
        
        try {
            const response = await fetch(`${basePath}/api/runpod/accounts/${encodeURIComponent(name)}/test`);
            const result = await response.json();
            
            if (result.status === 'connected') {
                let msg = `Account: ${name}\\nStatus: Connected\\nBalance: $${Number(result.balance || 0).toFixed(2)}\\nMachines: ${result.machine_count}`;
                if (result.machines && result.machines.length > 0) {
                    msg += '\\n\\nMachines:';
                    for (const m of result.machines) {
                        msg += `\\n  ${m.name}: ${m.gpu_total} GPUs (${m.gpu_rented} rented), listed=${m.listed}`;
                    }
                }
                alert(msg);
            } else {
                alert(`Account "${name}" test failed: ${result.error || 'Unknown error'}`);
            }
        } catch (e) {
            alert('Connection error: ' + e.message);
        }
        
        btn.disabled = false;
        btn.textContent = 'Test';
    }
    
    // Load accounts on page load
    loadVastAccounts();
    loadRunpodAccounts();
    </script>
</body></html>
