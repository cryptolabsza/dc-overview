# DC Overview - GPU Datacenter Monitoring Suite
# Docker Compose Configuration Template
#
# Usage:
#   1. Copy this file to your deployment directory
#   2. Update environment variables as needed
#   3. Run: docker-compose up -d

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./recording_rules.yml:/etc/prometheus/recording_rules.yml:ro
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=30d"
      - "--web.enable-lifecycle"
      - "--web.external-url=/prometheus/"
    networks:
      - monitoring

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-DcOverview2024!}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-piechart-panel
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      - GF_SERVER_ROOT_URL=${GRAFANA_ROOT_URL:-https://localhost:8443/grafana/}
    networks:
      - monitoring
    depends_on:
      - prometheus

  # Optional: Vast.ai Exporter (uncomment if using Vast.ai)
  # vastai-exporter:
  #   image: cryptolabsza/vastai-exporter:latest
  #   container_name: vastai-exporter
  #   restart: unless-stopped
  #   ports:
  #     - "8622:8622"
  #   environment:
  #     - VASTAI_API_KEY=${VASTAI_API_KEY}
  #   networks:
  #     - monitoring

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=86400

volumes:
  prometheus-data:
  grafana-data:

networks:
  monitoring:
    driver: bridge
